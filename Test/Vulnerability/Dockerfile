# Interpolation of the official owasp/za2docker-bare, but compatible with Azure DevOps Container Jobs.

FROM openjdk:11 AS builder

WORKDIR /zap

RUN apt-get update && apt-get install -y \
  wget \
  xmlstarlet

# Download and expand the latest stable release
RUN wget -qO- https://raw.githubusercontent.com/zaproxy/zap-admin/master/ZapVersions.xml | xmlstarlet sel -t -v //url |grep -i Linux | wget --content-disposition -i - -O - | tar zxv && \
	mv ZAP*/* . && \
	rm -R ZAP*

# Update add-ons
RUN ./zap.sh -cmd -silent -addonupdate
# Copy them to installation directory
RUN cp /root/.ZAP/plugin/*.zap plugin/ || :

FROM openjdk:11
LABEL maintainer="yburger@vxcompany.com"

WORKDIR /zap
COPY --from=builder /zap .
COPY policies /home/zap/.ZAP/policies/

RUN echo "zap2docker-bare" > /zap/container

RUN apt-get update && apt-get install -y \
  netcat-openbsd

ENV PATH $JAVA_HOME/bin:/zap/:$PATH
ENV ZAP_PATH /zap/zap.sh
ENV HOME /home/zap/
ENV ZAP_PORT 8080

HEALTHCHECK --retries=15 --interval=5s CMD nc -vz 127.0.0.1 $ZAP_PORT